<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Players</title>
    <link rel="stylesheet" href="./css/output.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300&display=swap"
      rel="stylesheet"
    />
    <script>
      const nameWithScore = [];
      async function fetchData() {
        const url = "http://localhost:3000/auth";
        const token = localStorage.getItem("token");

        if (!token) {
          console.error("Token not found in localStorage");
          return;
        }

        const headers = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        };

        try {
          const response = await fetch(url, {
            method: "GET",
            headers: headers,
          });

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error during GET request:", error);
          throw error; // Re-throw the error to reject the promise
        }
      }

      fetchData().then((data) => {
        console.log(data, "auth data");
        const fetchOperations = data.map((elem) => {
          const endpoint = "http://localhost:3000/players/team";
          let name = elem.name;
          let score = 0;
          const data = {
            id: String(elem._id),
          };
          console.log(elem._id);

          // Return the fetch promise
          return fetch(endpoint, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(data),
          })
            .then((response) => {
              if (!response.ok) {
                throw new Error(
                  `Network response was not ok. Status: ${response.status}`
                );
              }
              return response.json(); // Return the response data for further processing
            })
            .then((responseData) => {
              responseData.forEach((elem) => {
                score += elem.Score;
              });
              nameWithScore.push([name, score]);
            })
            .catch((error) => {
              console.error("Error during POST request:", error.message);
            });
        });

        // Wait for all fetch operations to complete before processing nameWithScore
        Promise.all(fetchOperations).then(() => {
          nameWithScore.sort((a, b) => b[1] - a[1]);
          console.log(nameWithScore);
          // Update the DOM with nameWithScore
          nameWithScore.forEach((element) => {
            var newDiv = document.createElement("div");
            newDiv.classList.add(
              "flex",
              "flex-row",
              "ml-10",
              "mr-16",
              "justify-items-center",
              "inline-block",
              "bg-zinc-200"
            );
            // Create and append the child elements
            var userNameDiv = document.createElement("div");
            userNameDiv.classList.add("ml-20");
            userNameDiv.textContent = element[0]; // Use index 0 for name
            newDiv.appendChild(userNameDiv);
            var scoreDiv = document.createElement("div");
            scoreDiv.classList.add("ml-20", "mr-20");
            scoreDiv.textContent = element[1]; // Use index 1 for score
            newDiv.appendChild(scoreDiv);
            // Append the newly created div to the existing content
            var dynamicContent = document.getElementById("dynamicContent");
            dynamicContent.appendChild(newDiv);
          });
        });
      });
    </script>
  </head>
  <body class="font-Poppins">
    <header class="flex flex-row flex-wrap justify-between">
      <img
        src="../FantasyEthiopialogos/FantasyEthiopia-logos_black.png"
        alt="_logo"
        class="w-1/5"
      />
      <nav class="m-4">
        <ul class="sm:inline-grid grid-cols-3 gap-4 font-bold">
          <li><a href="Home.html">Home</a></li>
          <li><a href="MyTeam.html" aria-current="page">My Team</a></li>
          <li><a href="About-User.html">About </a></li>
        </ul>
      </nav>
    </header>
    <main class="text-center">
      <section>
        <h2 class="font-bold text-lg mb-4 md:text-2xl"> Leader Board</h2>
      </section>
      <div id="dynamicContent"></div>
    </main>
    <footer class="text-center mt-20">
      <p
        ><span>&copy;</span>Fantasy-Ethiopia,
        <time datetime="2024-1-12">January, 2024</time>
      </p>
    </footer>
  </body>
</html>
